<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>JS工作室</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="JS工作室">
<meta property="og:url" content="http://blog.j3l11234.com/index.html">
<meta property="og:site_name" content="JS工作室">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JS工作室">
  
    <link rel="alternate" href="/atom.xml" title="JS工作室" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">JS工作室</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.j3l11234.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/02/22/hello-world/" class="article-date">
  <time datetime="2017-02-22T07:31:37.000Z" itemprop="datePublished">2017-02-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/02/22/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.j3l11234.com/2017/02/22/hello-world/" data-id="cizhrahj9000k4rh9a57kw1py" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>




  
    <article id="post-vue-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/04/vue-note/" class="article-date">
  <time datetime="2016-12-04T04:42:14.000Z" itemprop="datePublished">2016-12-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/12/04/vue-note/">Vue 笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li><code>vnode.data</code>里，<code>attrs</code>最终成为dom的普通属性，<code>domProps</code>成为内置属性(例如input的value)，决定一个属性是<code>attr</code>还是<code>domProp</code>,可以在<code>render()</code>里指定，如果是模板编译，则需要在模板编译里的<code>mustUseProp()</code>去指定。<br><a href="https://github.com/vuejs/vue/issues/4369" target="_blank" rel="external">https://github.com/vuejs/vue/issues/4369</a><br><a href="https://github.com/vuejs/vue/pull/4382" target="_blank" rel="external">https://github.com/vuejs/vue/pull/4382</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.j3l11234.com/2016/12/04/vue-note/" data-id="cizhrahj7000h4rh9bwxd71dj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>




  
    <article id="post-update-webpack-1to2" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/25/update-webpack-1to2/" class="article-date">
  <time datetime="2016-11-25T09:41:41.000Z" itemprop="datePublished">2016-11-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/25/update-webpack-1to2/">Webpack 1 更新到 Webpack 2 的蹚坑记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>　　真的就是手痒才更新到2的…</p>
</blockquote>
<p>##更新</p>
<hr>
<p>　　写此文时，webpack更新到2.1.0-beta.27。</p>
<p>首先运行更新命令：<br><code>npm install webpack@2.1.0-beta.27 --save-dev</code><br>如果要全局更新就使用：<br><code>npm install webpack@2.1.0-beta.27 --save-dev</code></p>
<p>　　更新完之后，webpack 2 兼容老版本的配置，所以直接运行是没有问题的。据说 webpack 2 的 <strong>tree-shaking</strong> 还可以优化体积。  </p>
<p>##迁移</p>
<hr>
<p>　　去webpack官网扫了一眼，虽然v2兼容v1的，但v2修改了配置文件的语法。<br><a href="https://webpack.js.org/guides/migrating/" target="_blank" rel="external">https://webpack.js.org/guides/migrating/</a></p>
<p>　　列举影响最深的两条:</p>
<blockquote>
<p>####<code>module.loaders</code> is now <code>module.rules</code><br>The old loader configuration was superseded by a more powerful rules system, which allows configuration of loaders and more. For compatibility reasons, the old module.loaders syntax is still valid and the old names are parsed. The new naming conventions are easier to understand and are a good reason to upgrade the configuration to using module.rules.</p>
<p>####<code>module.loaders</code> 更改为 <code>module.rules</code><br>　　旧版本的 loader 配置已经被更强大的 rules 取代，新的 rules 能够配置 loader 之外的更多选项。出于兼容考虑，旧的 <code>module.loaders</code> 语法仍然能被解析。然而，新的命名规范更易理解，推荐将配置文件更新为使用 <code>module.rules</code> 语法。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">  module: &#123;</div><div class="line">-   loaders: [</div><div class="line">+   rules: [</div><div class="line">      &#123;</div><div class="line">        test: /\.css$/,</div><div class="line">-       loaders: [</div><div class="line">+       use: [</div><div class="line">          &#123;</div><div class="line">            loader: &quot;style-loader&quot;</div><div class="line">          &#125;,</div><div class="line">          &#123;</div><div class="line">            loader: &quot;css-loader&quot;,</div><div class="line">-           query: &#123;</div><div class="line">+           options: &#123;</div><div class="line">              modules: true</div><div class="line">            &#125;</div><div class="line">        ]</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>####Automatic <code>-loader</code> module name extension removed<br>It is not possible anymore to omit the <code>-loader</code> extension when referencing loaders:</p>
<p>####在模块名后自动补上 -loader 后缀的功能被移除<br>　　在引用 loader 时，再也不能省略 <code>-loader</code> 后缀：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">        loaders: [</div><div class="line">-           &quot;style&quot;,</div><div class="line">+           &quot;style-loader&quot;,</div><div class="line">-           &quot;css&quot;,</div><div class="line">+           &quot;css-loader&quot;,</div><div class="line">-           &quot;less&quot;,</div><div class="line">+           &quot;less-loader&quot;,</div><div class="line">        ]</div></pre></td></tr></table></figure></p>
<p>You can still opt-in to the old behavior with the <code>resolveLoader.moduleExtensions</code> configuration option.<br>　　你可以通过添加 <code>resolveLoader.moduleExtensions</code> 配置项，继续使用以前的格式。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">resolveLoader: &#123;</div><div class="line">  moduleExtensions: [&quot;-loader&quot;]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>　　愉快的改好<code>webpack.config.js</code>，接下来开始曲折的趟坑之旅。</p>
<p>##蹚坑</p>
<hr>
<p>　　满心欢喜的build一发。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">$ npm run build</div><div class="line"></div><div class="line">&gt; hdzx_v4_html@1.0.0 build /Users/j3l11234/Documents/nodejs/hdzx_v4_html</div><div class="line">&gt; gulp build</div><div class="line"></div><div class="line">[15:28:59] Using gulpfile ~/Documents/nodejs/hdzx_v4_html/gulpfile.js</div><div class="line">[15:28:59] Starting &apos;clean&apos;...</div><div class="line">[15:28:59] Finished &apos;clean&apos; after 21 ms</div><div class="line">[15:28:59] Starting &apos;build&apos;...</div><div class="line">[15:28:59] Starting &apos;style&apos;...</div><div class="line">[15:28:59] Finished &apos;style&apos; after 21 ms</div><div class="line">[15:28:59] Starting &apos;webpack&apos;...</div><div class="line">[15:28:59] Finished &apos;webpack&apos; after 297 ms</div><div class="line">[15:28:59] Finished &apos;build&apos; after 320 ms</div><div class="line">[15:29:01] Plumber found unhandled error:</div><div class="line"> Error in plugin &apos;webpack-stream&apos;</div><div class="line">Message:</div><div class="line">    ./src/js/approve/index.js</div><div class="line">Module parse failed: /Users/j3l11234/Documents/nodejs/hdzx_v4_html/src/js/approve/index.js Unexpected token (180:6)</div><div class="line">You may need an appropriate loader to handle this file type.</div><div class="line">SyntaxError: Unexpected token (180:6)</div><div class="line">    at Parser.pp$4.raise (/Users/j3l11234/Documents/nodejs/hdzx_v4_html/node_modules/.npminstall/acorn/3.3.0/acorn/dist/acorn.js:2221:15)</div><div class="line">    at Parser.pp.unexpected (/Users/j3l11234/Documents/nodejs/hdzx_v4_html/node_modules/.npminstall/acorn/3.3.0/acorn/dist/acorn.js:603:10)</div><div class="line">```  </div><div class="line">　　诶？这和剧本写的不一样啊？check一下配置文件：</div></pre></td></tr></table></figure></p>
<p>  module: {<br>    rules: [<br>      {<br>        test: /.jsx?$/,<br>        loader: ‘babel-loader’,<br>        exclude: /node_modules/,<br>        options: {<br>          ‘presets’: [<br>            [‘es2015’, {modules: false}],<br>            ‘react’<br>          ]<br>        }<br>      }<br>    ]<br>  },<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">　　无肉眼可见的配置错误，不过提示**You may need an appropriate loader to handle this file type.**，也就是loader没有载入出来。经过几个世纪的测试，最后试了一条命令：</div></pre></td></tr></table></figure></p>
<p>$ ./node_modules/webpack/bin/webpack.js<br>Hash: e2a6ffe6d35f21cf8167<br>Version: webpack 2.1.0-beta.27<br>Time: 3127ms<br>         Asset      Size  Chunks             Chunk Names<br>  order.js.map  85 bytes       0  [emitted]  order<br>      order.js   1.46 kB       0  [emitted]  order<br>      login.js   1.54 kB       2  [emitted]  login<br>       lock.js   1.82 kB       3  [emitted]  lock<br>      issue.js   1.51 kB       4  [emitted]  issue<br>    approve.js   1.09 kB       5  [emitted]  approve<br>     common.js    728 kB       6  [emitted]  common<br>    myorder.js   1.33 kB       1  [emitted]  myorder<br>myorder.js.map  87 bytes       1  [emitted]  myorder<br>  login.js.map  85 bytes       2  [emitted]  login<br>   lock.js.map  84 bytes       3  [emitted]  lock<br>  issue.js.map  85 bytes       4  [emitted]  issue<br>approve.js.map  87 bytes       5  [emitted]  approve<br> common.js.map    893 kB       6  [emitted]  common<br> [189] multi common 64 bytes {6} [built]</p>
<pre><code>+ 189 hidden modules
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">　　直接去调用 node_modules 里的 webpack 是成功的，使用 gulp 就不行，而 gulp 借助 webpack-stream 来实现 webpack 调用，莫非是 webpack-stream 的问题？翻出 webpack-stream 的 `package.json`：</div><div class="line">```json</div><div class="line">&#123;</div><div class="line">  &quot;name&quot;: &quot;webpack-stream&quot;,</div><div class="line">  &quot;version&quot;: &quot;3.2.0&quot;,</div><div class="line">  &quot;description&quot;: &quot;Run webpack as a stream&quot;,</div><div class="line">  &quot;license&quot;: &quot;MIT&quot;,</div><div class="line">  &quot;homepage&quot;: &quot;https://github.com/shama/webpack-stream&quot;,</div><div class="line">  &quot;repository&quot;: &quot;shama/webpack-stream&quot;,</div><div class="line">  &quot;author&quot;: &#123;</div><div class="line">    &quot;name&quot;: &quot;Kyle Robinson Young&quot;,</div><div class="line">    &quot;email&quot;: &quot;kyle@dontkry.com&quot;,</div><div class="line">    &quot;url&quot;: &quot;http://dontkry.com&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;engines&quot;: &#123;</div><div class="line">    &quot;node&quot;: &quot;&gt;= 0.10.0&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;scripts&quot;: &#123;</div><div class="line">    &quot;test&quot;: &quot;semistandard &amp;&amp; node test/test.js&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;files&quot;: [</div><div class="line">    &quot;index.js&quot;</div><div class="line">  ],</div><div class="line">  &quot;semistandard&quot;: &#123;</div><div class="line">    &quot;ignore&quot;: [</div><div class="line">      &quot;test/fixtures&quot;,</div><div class="line">      &quot;examples&quot;</div><div class="line">    ]</div><div class="line">  &#125;,</div><div class="line">  &quot;dependencies&quot;: &#123;</div><div class="line">    &quot;gulp-util&quot;: &quot;^3.0.7&quot;,</div><div class="line">    &quot;lodash.clone&quot;: &quot;^4.3.2&quot;,</div><div class="line">    &quot;lodash.some&quot;: &quot;^4.2.2&quot;,</div><div class="line">    &quot;memory-fs&quot;: &quot;^0.3.0&quot;,</div><div class="line">    &quot;through&quot;: &quot;^2.3.8&quot;,</div><div class="line">    &quot;vinyl&quot;: &quot;^1.1.0&quot;,</div><div class="line">    &quot;webpack&quot;: &quot;^1.12.9&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;devDependencies&quot;: &#123;</div><div class="line">    &quot;gulp&quot;: &quot;^3.9.0&quot;,</div><div class="line">    &quot;rimraf&quot;: &quot;^2.4.4&quot;,</div><div class="line">    &quot;semistandard&quot;: &quot;^7.0.4&quot;,</div><div class="line">    &quot;tape&quot;: &quot;^4.2.2&quot;,</div><div class="line">    &quot;vinyl-fs&quot;: &quot;^2.2.1&quot;,</div><div class="line">    &quot;vinyl-named&quot;: &quot;^1.1.0&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;keywords&quot;: [</div><div class="line">    &quot;gulpplugin&quot;,</div><div class="line">    &quot;webpack&quot;,</div><div class="line">    &quot;stream&quot;</div><div class="line">  ],</div><div class="line">  &quot;_from&quot;: &quot;webpack-stream@3.2.0&quot;,</div><div class="line">  &quot;_resolved&quot;: &quot;http://registry.npm.taobao.org/webpack-stream/download/webpack-stream-3.2.0.tgz&quot;</div><div class="line">&#125;</div><div class="line">```  </div><div class="line">　　OMG，webpack-stream 依赖的是 webpack^1.12.9 ，于是在使用 gulp 的时候，最终调用的还是 webpack^1.12.9，于是配置里的 rules 不被识别， loader 声明无效， build错误也就是完全可以理解的了。  </div><div class="line">　　老方法，看源码：</div><div class="line">```javascript</div><div class="line">module.exports = function (options, wp, done) &#123;</div><div class="line">  ...</div><div class="line"></div><div class="line">  var webpack = wp || require(&apos;webpack&apos;);</div><div class="line"></div><div class="line">  ...</div><div class="line">&#125;;</div><div class="line">```  </div><div class="line">　　看到闪闪发光的一行，webpack-stream 是可以注入 webpack 实例的，如果不注入，就使用 `require(&apos;webpack&apos;)` 引入 webpack-stream 自身所依赖的 webpack^1.12.9 。  </div><div class="line">　　怒改 `gulpfile.js`，在调用 webpack-stream 的时候手动传入 `require(&apos;webpack&apos;)` 。</div><div class="line">```javascript</div><div class="line">gulp.task(&apos;webpack-watch&apos;, function() &#123;</div><div class="line">  gulp.src(&apos;./src/js/**/*.js&apos;)</div><div class="line">    .pipe(plumber())</div><div class="line">    .pipe(webpack(Object.assign(require(&apos;./webpack.config.js&apos;),&#123;watch:true&#125;),require(&apos;webpack&apos;)))</div><div class="line">    .pipe(gulp.dest(DIST + &apos;/js&apos;));</div><div class="line">&#125;);</div><div class="line"></div><div class="line">gulp.task(&apos;webpack&apos;, function() &#123;</div><div class="line">  gulp.src(&apos;./src/js/**/*.js&apos;)</div><div class="line">    .pipe(plumber())</div><div class="line">    .pipe(webpack(require(&apos;./webpack.config.js&apos;),require(&apos;webpack&apos;)))</div><div class="line">    .pipe(gulp.dest(DIST + &apos;/js&apos;));</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>　　再 build 一把，一次OK：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">$ npm run build</div><div class="line"></div><div class="line">&gt; hdzx_v4_html@1.0.0 build /Users/j3l11234/Documents/nodejs/hdzx_v4_html</div><div class="line">&gt; gulp build</div><div class="line"></div><div class="line">[17:05:48] Using gulpfile ~/Documents/nodejs/hdzx_v4_html/gulpfile.js</div><div class="line">[17:05:48] Starting &apos;clean&apos;...</div><div class="line">[17:05:48] Finished &apos;clean&apos; after 6.6 ms</div><div class="line">[17:05:48] Starting &apos;build&apos;...</div><div class="line">[17:05:48] Starting &apos;style&apos;...</div><div class="line">[17:05:48] Finished &apos;style&apos; after 14 ms</div><div class="line">[17:05:48] Starting &apos;webpack&apos;...</div><div class="line">[17:05:48] Finished &apos;webpack&apos; after 348 ms</div><div class="line">[17:05:48] Finished &apos;build&apos; after 364 ms</div><div class="line">[17:06:00] Version: webpack 2.1.0-beta.27</div><div class="line">         Asset    Size  Chunks             Chunk Names</div><div class="line">  order.js.map  238 kB       0  [emitted]  order</div><div class="line">      order.js  230 kB       0  [emitted]  order</div><div class="line">    myorder.js  169 kB       2  [emitted]  myorder</div><div class="line">    approve.js  172 kB       3  [emitted]  approve</div><div class="line">      issue.js  145 kB       4  [emitted]  issue</div><div class="line">      login.js  101 kB       5  [emitted]  login</div><div class="line">     common.js  729 kB       6  [emitted]  common</div><div class="line">       lock.js  183 kB       1  [emitted]  lock</div><div class="line">   lock.js.map  195 kB       1  [emitted]  lock</div><div class="line">myorder.js.map  184 kB       2  [emitted]  myorder</div><div class="line">approve.js.map  190 kB       3  [emitted]  approve</div><div class="line">  issue.js.map  161 kB       4  [emitted]  issue</div><div class="line">  login.js.map  121 kB       5  [emitted]  login</div><div class="line"> common.js.map  894 kB       6  [emitted]  common</div></pre></td></tr></table></figure></p>
<p>　　老哥，稳。</p>
<p>##后记</p>
<hr>
<p>　　台上一分钟，台下十年功，博客写的6，其实找问题的时候真的想疯。然后，不看 github 真是太傻了，下次遇到问题一定要到全球最大的同性交友平台问问！<br><a href="https://github.com/shama/webpack-stream/issues/125" target="_blank" rel="external">https://github.com/shama/webpack-stream/issues/125</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.j3l11234.com/2016/11/25/update-webpack-1to2/" data-id="cizhrahj8000i4rh9gqdyn6gb" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>




  
    <article id="post-yum-remove-with-exclude" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/11/23/yum-remove-with-exclude/" class="article-date">
  <time datetime="2016-11-22T16:20:36.000Z" itemprop="datePublished">2016-11-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/11/23/yum-remove-with-exclude/">在 yum remove 时保留特定依赖</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>　　其实这个问题出现得很偶然，就是学校云平台上预装的linux是CentOS7 Desktop，装了一大堆用不到的奇怪玩意……<br>　　为了节约内存和硬盘，还有作为一个前端兼运维的强迫症，用不到的东西肯定就得删掉了，毕竟眼不见为净嘛。</p>
<blockquote>
<p><strong><u>看代码请直接拉到页底</u></strong></p>
</blockquote>
<p>首先祭出<code>yum remove</code>大法:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"># yum remove perl-*</div><div class="line"></div><div class="line">[...]</div><div class="line"></div><div class="line">Dependencies Resolved</div><div class="line"></div><div class="line">================================================================================</div><div class="line"> Package                       Arch   Version              Repository      Size</div><div class="line">================================================================================</div><div class="line">Removing:</div><div class="line"> perl                          x86_64 4:5.16.3-283.el7     @anaconda       22 M</div><div class="line"> perl-Carp                     noarch 1.26-244.el7         @anaconda       28 k</div><div class="line"> perl-Compress-Raw-Bzip2       x86_64 2.061-3.el7          @anaconda       57 k</div><div class="line"> perl-Compress-Raw-Zlib        x86_64 1:2.061-4.el7        @anaconda      137 k</div><div class="line"> perl-DBI                      x86_64 1.627-4.el7          @anaconda      1.9 M</div><div class="line"> perl-Data-Dumper              x86_64 2.145-3.el7          @anaconda       97 k</div><div class="line"> perl-Encode                   x86_64 2.51-7.el7           @anaconda      9.7 M</div><div class="line"> perl-Error                    noarch 1:0.17020-2.el7      @anaconda       49 k</div><div class="line"> perl-Exporter                 noarch 5.68-3.el7           @anaconda       55 k</div><div class="line"> perl-File-Path                noarch 2.09-2.el7           @anaconda       49 k</div><div class="line"> perl-File-Temp                noarch 0.23.01-3.el7        @anaconda      155 k</div><div class="line"> perl-Filter                   x86_64 1.49-3.el7           @anaconda      145 k</div><div class="line"> perl-Getopt-Long              noarch 2.40-2.el7           @anaconda      132 k</div><div class="line"> perl-Git                      noarch 2.10.0-1.gf.el7      @/perl-Git-2.10.0-1.gf.el7.noarch</div><div class="line">                                                                           61 k</div><div class="line"> perl-HTTP-Tiny                noarch 0.033-3.el7          @anaconda       95 k</div><div class="line"> perl-IO-Compress              noarch 2.061-2.el7          @anaconda      795 k</div><div class="line"> perl-Net-Daemon               noarch 0.48-5.el7           @anaconda      116 k</div><div class="line"> perl-PathTools                x86_64 3.40-5.el7           @anaconda      170 k</div><div class="line"> perl-PlRPC                    noarch 0.2020-14.el7        @anaconda       69 k</div><div class="line"> perl-Pod-Escapes              noarch 1:1.04-283.el7       @anaconda       21 k</div><div class="line"> perl-Pod-Perldoc              noarch 3.20-4.el7           @anaconda      163 k</div><div class="line"> perl-Pod-Simple               noarch 1:3.28-4.el7         @anaconda      526 k</div><div class="line"> perl-Pod-Usage                noarch 1.63-3.el7           @anaconda       44 k</div><div class="line"> perl-Scalar-List-Utils        x86_64 1.27-248.el7         @anaconda       66 k</div><div class="line"> perl-Socket                   x86_64 2.010-3.el7          @anaconda      112 k</div><div class="line"> perl-Storable                 x86_64 2.45-3.el7           @anaconda      177 k</div><div class="line"> perl-TermReadKey              x86_64 2.30-20.el7          @anaconda       59 k</div><div class="line"> perl-Text-ParseWords          noarch 3.29-4.el7           @anaconda       16 k</div><div class="line"> perl-Time-Local               noarch 1.2300-2.el7         @anaconda       43 k</div><div class="line"> perl-constant                 noarch 1.27-2.el7           @anaconda       26 k</div><div class="line"> perl-libs                     x86_64 4:5.16.3-283.el7     @anaconda      1.6 M</div><div class="line"> perl-macros                   x86_64 4:5.16.3-283.el7     @anaconda      5.0 k</div><div class="line"> perl-parent                   noarch 1:0.225-244.el7      @anaconda      8.0 k</div><div class="line"> perl-podlators                noarch 2.5.1-3.el7          @anaconda      281 k</div><div class="line"> perl-threads                  x86_64 1.87-4.el7           @anaconda       96 k</div><div class="line"> perl-threads-shared           x86_64 1.43-6.el7           @anaconda       72 k</div><div class="line">Removing for dependencies:</div><div class="line"> MariaDB-client                x86_64 10.1.18-1.el7.centos @/MariaDB-10.1.18-centos7-x86_64-client</div><div class="line">                                                                          170 M</div><div class="line"> MariaDB-server                x86_64 10.1.18-1.el7.centos @/MariaDB-10.1.18-centos7-x86_64-server</div><div class="line">                                                                          428 M</div><div class="line"> git                           x86_64 2.10.0-1.gf.el7      @/git-2.10.0-1.gf.el7.x86_64</div><div class="line">                                                                          2.4 M</div><div class="line"></div><div class="line">[...]</div><div class="line"></div><div class="line">Transaction Summary</div><div class="line">================================================================================</div><div class="line">Remove  36 Packages (+35 Dependent packages)</div><div class="line"></div><div class="line">Installed size: 793 M</div><div class="line">Is this ok [y/N]</div></pre></td></tr></table></figure></p>
<p>　　列出了好多东西，看得笔者心花怒放，但是，诶？？？怎么<em>MariaDB</em>和<em>git</em>也要被一起删掉呢，仔细一看：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"># yum deplist Mariadb</div><div class="line"></div><div class="line">Loaded plugins: fastestmirror, langpacks</div><div class="line">Loading mirror speeds from cached hostfile</div><div class="line"> * base: mirrors.tuna.tsinghua.edu.cn</div><div class="line"> * extras: mirrors.tuna.tsinghua.edu.cn</div><div class="line"> * updates: mirrors.tuna.tsinghua.edu.cn</div><div class="line">package: mariadb.x86_64 1:5.5.50-1.el7_2</div><div class="line"></div><div class="line">[...]</div><div class="line"></div><div class="line">  dependency: mariadb-libs(x86-64) = 1:5.5.50-1.el7_2</div><div class="line">   provider: mariadb-libs.x86_64 1:5.5.50-1.el7_2</div><div class="line">  dependency: perl(Exporter)</div><div class="line">   provider: perl-Exporter.noarch 5.68-3.el7</div><div class="line">  dependency: perl(Fcntl)</div><div class="line">   provider: perl.x86_64 4:5.16.3-286.el7</div><div class="line">  dependency: perl(File::Temp)</div><div class="line">   provider: perl-File-Temp.noarch 0.23.01-3.el7</div><div class="line">  dependency: perl(Getopt::Long)</div><div class="line">   provider: perl-Getopt-Long.noarch 2.40-2.el7</div><div class="line">  dependency: perl(IPC::Open3)</div><div class="line">   provider: perl.x86_64 4:5.16.3-286.el7</div><div class="line">  dependency: perl(Sys::Hostname)</div><div class="line">   provider: perl.x86_64 4:5.16.3-286.el7</div></pre></td></tr></table></figure></p>
<p>　　原因找到了，因为MariaDB依赖了perl的某些组件，<em>perl-*</em>粗暴的把这些被依赖的组件包括在里面了，这该怎么办呢？</p>
<h2 id="弯路"><a href="#弯路" class="headerlink" title="弯路"></a>弯路</h2><hr>
<p>想了几个解决方案：</p>
<ul>
<li><p><strong>先一起删除，再重新安装</strong><br>　　这个方法总有点向黑恶势力低头的感觉，最关键是的是，MariaDB是<u>跑着服务</u>的。否决。</p>

</li>
<li><p><strong>忽略依赖关系强制删除</strong><br>　　使用<code>yum remove XXX --nodepes</code>这样的必杀技，无视依赖关系强制删除，再使用<code>yum check</code>修复依赖关系，一种把人打个半死再治好的既视感。否决。<br>　　yum官方也不资瓷这样的方法。<a href="http://yum.baseurl.org/wiki/NoDeps" target="_blank" rel="external">http://yum.baseurl.org/wiki/NoDeps</a></p>
</li>
<li><p><strong>修改yum</strong><br>　　笔者一怒之下去 <a href="yum.baseurl.org">yum.baseurl.org</a> 扒了源码下来，在<code>__init__.py</code>里的<code>remove()</code>看了半天，找不到足够优雅的切入点去改，于是放弃。。。</p>
</li>
</ul>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><hr>
<p>　　就思路本身而言，其实很简单，举个栗子，需要删除foo-a、foo-b、foo-c三个软件包，但是需要保留bar-a，而bar-a依赖于bar-b，bar-b依赖于foo-b。  </p>
<p>匹配foo-*匹配，得到：<br><code>A = [foo-a, foo-b, foo-c]</code><br>计算bar-a的依赖，得到：<br><code>B = [bar-a, bar-b, foo-b]</code><br>取其差集：<br><code>C = A - B = [foo-a, foo-c]</code><br>卸载C，是不会影响到bar-a的。</p>
<p>##技术点</p>
<hr>
<p>####RepoQuery<br>官网介绍：<a href="http://yum.baseurl.org/wiki/RepoQuery" target="_blank" rel="external">http://yum.baseurl.org/wiki/RepoQuery</a></p>
<blockquote>
<p>Repoquery is a yum-util that has an array of involved and complicated options. It is intended to be an analog to rpm -q commands but run on remote repositories. This accounts for why it is complicated and involved :)</p>
<p>Repoquery是一个包含高级选项的yum-util，它类似于rpm -q命令，但是涉及远程仓库，这也是它更复杂的原因 :)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"># repoquery  --help</div><div class="line">Usage: repoquery [options]</div><div class="line"></div><div class="line">Options:</div><div class="line">  --version             show program&apos;s version number and exit</div><div class="line">  -h, --help            show this help message and exit</div><div class="line">  -l, --list            list files in this package/group</div><div class="line">  -i, --info            list descriptive info from this package/group</div><div class="line">  -f, --file            query which package provides this file</div><div class="line">  --qf=QUERYFORMAT, --queryformat=QUERYFORMAT</div><div class="line">                        specify a custom output format for queries</div><div class="line">  --groupmember         list which group(s) this package belongs to</div><div class="line">  -q, --query           no-op for rpmquery compatibility</div><div class="line">  -a, --all             query all packages/groups</div><div class="line">  -R, --requires        list package dependencies</div><div class="line">  --provides            list capabilities this package provides</div><div class="line">  --obsoletes           list other packages obsoleted by this package</div><div class="line">  --conflicts           list capabilities this package conflicts with</div><div class="line">  --changelog           show changelog for this package</div><div class="line">  --location            show download URL for this package</div><div class="line">  --nevra               show name-epoch:version-release.architecture info of</div><div class="line">                        package</div><div class="line">  --envra               show epoch:name-version-release.architecture info of</div><div class="line">                        package</div><div class="line">  --nvr                 show name, version, release info of package</div><div class="line">  -s, --source          show package source RPM name</div><div class="line">  --srpm                operate on corresponding source RPM</div><div class="line">  --resolve             resolve capabilities to originating package(s)</div><div class="line">  --alldeps             check non-explicit dependencies (files and Provides:)</div><div class="line">                        as well, defaults to on</div><div class="line">  --exactdeps           check dependencies exactly as given, opposite of</div><div class="line">                        --alldeps</div><div class="line">  --recursive           recursively query for packages (for whatrequires)</div><div class="line">  --whatprovides        query what package(s) provide a capability</div><div class="line">  --whatrequires        query what package(s) require a capability</div><div class="line">  --whatobsoletes       query what package(s) obsolete a capability</div><div class="line">  --whatconflicts       query what package(s) conflicts with a capability</div><div class="line">  -g, --group           query groups instead of packages</div><div class="line">  --grouppkgs=GROUPPKGS</div><div class="line">                        filter which packages (all,optional etc) are shown</div><div class="line">                        from groups</div><div class="line">  --archlist=ARCHLIST   only query packages of certain architecture(s)</div><div class="line">  --releasever=RELEASEVER</div><div class="line">                        set value of $releasever in yum config and repo files</div><div class="line">  --pkgnarrow=PKGNARROW</div><div class="line">                        limit query to installed / available / recent /</div><div class="line">                        updates / extras / all (available + installed) /</div><div class="line">                        repository (default) packages</div><div class="line">  --installed           limit query to installed pkgs only</div><div class="line">  --show-duplicates     show all versions of packages</div><div class="line">  --repoid=REPOID       specify repoids to query, can be specified multiple</div><div class="line">                        times (default is all enabled)</div><div class="line">  --enablerepo=ENABLEREPOS</div><div class="line">                        specify additional repoids to query, can be specified</div><div class="line">                        multiple times</div><div class="line">  --disablerepo=DISABLEREPOS</div><div class="line">                        specify repoids to disable, can be specified multiple</div><div class="line">                        times</div><div class="line">  --repofrompath=REPOFROMPATH</div><div class="line">                        specify repoid &amp; paths of additional repositories -</div><div class="line">                        unique repoid and complete path required, can be</div><div class="line">                        specified multiple times. Example.</div><div class="line">                        --repofrompath=myrepo,/path/to/repo</div><div class="line">  --plugins             enable yum plugin support</div><div class="line">  --quiet               quiet output, only error output to stderr (default</div><div class="line">                        enabled)</div><div class="line">  --verbose             verbose output (opposite of quiet)</div><div class="line">  -C, --cache           run from cache only</div><div class="line">  --tempcache           use private cache (default when used as non-root)</div><div class="line">  --querytags           list available tags in queryformat queries</div><div class="line">  -c CONFFILE, --config=CONFFILE</div><div class="line">                        config file location</div><div class="line">  --level=TREE_LEVEL    levels to display (can be any number or &apos;all&apos;, default</div><div class="line">                        to &apos;all&apos;)</div><div class="line">  --output=OUTPUT       output format to use (can be text|ascii-tree|dot-tree,</div><div class="line">                        default to &apos;text&apos;)</div><div class="line">  --search              Use yum&apos;s search to return pkgs</div><div class="line">  --search-fields=SEARCHFIELDS</div><div class="line">                        search fields to search using --search</div><div class="line">  --installroot=INSTALLROOT</div><div class="line">                        set install root</div><div class="line">  --setopt=SETOPTS      set arbitrary config and repo options</div></pre></td></tr></table></figure>
<p>　　Repoquery就是<code>rpm -q</code>的高配版，用法很简单，在这里被用于查询依赖关系：<br>  <code>repoquery --requires --resolve --pkgnarrow=installed --recursive bar</code></p>
<ul>
<li><em>–requires</em> 查找其依赖</li>
<li><em>–resolve</em> 将依赖(dependency)转换成包名(provider)</li>
<li><em>–pkgnarrow=installed</em> 只查找已安装的包</li>
<li><em>–recursive</em> 递归查找依赖</li>
</ul>
<p>##实现</p>
<hr>
<p>　　笔者决定用最不擅长的一次就没写过的Python来解决问题，于是，在寒冷的冬夜里，在公司默默加班奋斗，一边查资料一边写脚本。</p>
<blockquote>
<p>Talk is cheap. Show me the code.</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</div><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> unicode_literals</div><div class="line"></div><div class="line"><span class="keyword">import</span> sys, getopt</div><div class="line"><span class="keyword">import</span> commands</div><div class="line"><span class="keyword">import</span> re</div><div class="line"><span class="keyword">import</span> subprocess</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(argv)</span>:</span></div><div class="line"></div><div class="line">    <span class="comment"># get options from arguments</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        opts, args = getopt.getopt(argv,<span class="string">"he:x:v"</span>,[<span class="string">"help"</span>, <span class="string">"exclude="</span>])</div><div class="line">    <span class="keyword">except</span> getopt.GetoptError <span class="keyword">as</span> err:</div><div class="line">        print(str(err))</div><div class="line">        usage()</div><div class="line">        sys.exit(<span class="number">2</span>)</div><div class="line"></div><div class="line">    remove_package = <span class="string">''</span></div><div class="line">    exclude_package = <span class="string">''</span></div><div class="line">    verbose = <span class="keyword">False</span></div><div class="line">    <span class="keyword">for</span> opt, arg <span class="keyword">in</span> opts:</div><div class="line">        <span class="keyword">if</span> opt <span class="keyword">in</span> (<span class="string">'-h'</span>, <span class="string">'help'</span>):</div><div class="line">            usage()</div><div class="line">            sys.exit()</div><div class="line">        <span class="keyword">elif</span> opt <span class="keyword">in</span> (<span class="string">'-e'</span>):</div><div class="line">            remove_package = arg</div><div class="line">        <span class="keyword">elif</span> opt <span class="keyword">in</span> (<span class="string">'-x'</span>, <span class="string">'--exclude'</span>):</div><div class="line">            exclude_package = arg</div><div class="line">        <span class="keyword">elif</span> opt <span class="keyword">in</span> (<span class="string">'-v'</span>):</div><div class="line">            verbose = <span class="keyword">True</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> remove_package == <span class="string">''</span> <span class="keyword">or</span> exclude_package == <span class="string">''</span>:</div><div class="line">        print(<span class="string">'wrong arvs!'</span>)</div><div class="line">        usage()</div><div class="line">        sys.exit(<span class="number">2</span>)</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment"># get exclude packages</span></div><div class="line">    print(<span class="string">'analyzing exclude packages and their dependencies ...'</span>)</div><div class="line">    (status, output) = commands.getstatusoutput(<span class="string">'repoquery --requires --resolve --pkgnarrow=installed --recursive '</span>+ exclude_package)</div><div class="line">    deplist = set()</div><div class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> output.splitlines():</div><div class="line">        deplist.add(line)</div><div class="line">    <span class="keyword">if</span> verbose:</div><div class="line">        print(<span class="string">'exclude packages:\n'</span>+<span class="string">'\n'</span>.join(deplist))</div><div class="line">    print(<span class="string">''</span>)</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment"># get packages to remove</span></div><div class="line">    print(<span class="string">'analyzing packages which will be removed...'</span>)</div><div class="line">    removelist = set()</div><div class="line">    (status, output) = commands.getstatusoutput(<span class="string">'repoquery --pkgnarrow=installed '</span>+ remove_package)</div><div class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> output.splitlines():</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> line <span class="keyword">in</span> deplist:</div><div class="line">            removelist.add(line)</div><div class="line">            <span class="keyword">if</span> verbose:</div><div class="line">                print(<span class="string">'passed: '</span>+line)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">if</span> verbose:</div><div class="line">                print(<span class="string">'skiped: '</span>+line)</div><div class="line">    print(<span class="string">''</span>)</div><div class="line"></div><div class="line"></div><div class="line">    <span class="keyword">if</span> len(removelist) &lt; <span class="number">1</span>:</div><div class="line">        print(<span class="string">'Nothing to remove!'</span>)</div><div class="line">        sys.exit(<span class="number">0</span>)</div><div class="line">    pipe = subprocess.Popen(<span class="string">'yum remove '</span>+ <span class="string">' '</span>.join(removelist), stdin = sys.stdin, stdout = sys.stdout, shell=<span class="keyword">True</span>)</div><div class="line">    pipe.communicate()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">usage</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">'remove.py -e &lt;remove_package&gt; -x &lt;exclude_package&gt;'</span>)</div><div class="line">    print(<span class="string">'example: remove.py -e perl-* -x \'mysql* git*\''</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">   main(sys.argv[<span class="number">1</span>:])</div></pre></td></tr></table></figure>
<p><em>这是笔者的处女Python啊!!!</em><br><em>这是笔者的处女Python啊!!!</em><br><em>这是笔者的处女Python啊!!!</em><br><em>多年的强迫症加重了!!!</em></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.j3l11234.com/2016/11/23/yum-remove-with-exclude/" data-id="cizhrahj9000j4rh9ccs16qux" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>




  
    <article id="post-hdzx_v4-launched" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/09/hdzx_v4-launched/" class="article-date">
  <time datetime="2016-10-09T08:36:22.000Z" itemprop="datePublished">2016-10-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/09/hdzx_v4-launched/">学活新版本系统上线了</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>占坑</p>
<h2 id="Changelog"><a href="#Changelog" class="headerlink" title="Changelog"></a>Changelog</h2><ul>
<li>2016.11.20<ul>
<li>新增 申请页面可以看到开放时间</li>
<li>新增 审批申请时可以快速查询冲突情况</li>
<li>优化 后台数据处理逻辑</li>
<li>优化 审批数据后端分页</li>
<li>优化 冲突申请分析策略</li>
<li>优化 房间使用表的数据结构</li>
<li>修改 琴房审批页面地址</li>
<li>修复 申请重设密码不显示结果的bug</li>
<li>更新 后端框架全面适配Yii 2.0.10</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>2016.11.07<ul>
<li>新增 审批页面增加条件筛选功能</li>
<li>优化 首页轮播显示逻辑</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>2016.11.04<ul>
<li>新增 前台导航栏支持二级导航</li>
<li>新增 前台关于页和房间介绍页</li>
<li>优化 前后端Ajax数据交换格式</li>
<li>优化 后端异常处理机制</li>
<li>修复 前台导航栏信息和链接错误</li>
<li>修改 激活新账号页面文本提示</li>
<li>修复 激活新账号不显示结果的bug</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>2016.10.31<ul>
<li>新增 前台导航栏变为可配置</li>
<li>新增 后台登录页页面提示</li>
<li>优化 邮件验证结果提示</li>
<li>优化 缓存前台导航栏内容</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>2016.10.28<ul>
<li>迁移 从曙光服务器迁移到信息中心云平台</li>
<li>迁移 数据库从MySQL迁移到MariaDB</li>
<li>优化 页面header生成逻辑</li>
<li>修改 页面文本提示微调</li>
<li>修复 自动审批时可能出现错误的bug</li>
<li>修复 查询开门条时出现错误的bug</li>
<li>更新 后端框架更新到Yii 2.0.10</li>
<li>修复 自动审批日志泄露敏感信息的问题</li>
<li>优化 页面加载元数据的逻辑</li>
<li>优化 在双核浏览器中优先使用webkit内核</li>
<li>优化 前端验证码加载逻辑</li>
<li>优化 前端组件渲染效率</li>
<li>修复 前端清除冗余的console.log()</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>2016.10.08<ul>
<li>第四版系统上线</li>
<li>前端核心页面使用React.js构建</li>
<li>后端使用Yii框架</li>
</ul>
</li>
</ul>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><p>未完待续。。。得空开源</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.j3l11234.com/2016/10/09/hdzx_v4-launched/" data-id="cizhrahj5000g4rh9p9m6xc3a" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>




  
    <article id="post-selinux-nginx" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/19/selinux-nginx/" class="article-date">
  <time datetime="2016-09-18T17:04:43.000Z" itemprop="datePublished">2016-09-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/19/selinux-nginx/">SELinux下nginx的配置</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>留坑</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.j3l11234.com/2016/09/19/selinux-nginx/" data-id="cizhrahj4000f4rh9g2dvrhfu" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>




  
    <article id="post-nginx-url-prefix-vhost" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/19/nginx-url-prefix-vhost/" class="article-date">
  <time datetime="2016-09-18T17:04:07.000Z" itemprop="datePublished">2016-09-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/19/nginx-url-prefix-vhost/">nginx以url前缀作为虚拟主机</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>留坑</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.j3l11234.com/2016/09/19/nginx-url-prefix-vhost/" data-id="cizhrahj3000e4rh99n9k5tmg" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>




  
    <article id="post-wordpress2ghost" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/13/wordpress2ghost/" class="article-date">
  <time datetime="2016-09-12T18:09:37.000Z" itemprop="datePublished">2016-09-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/13/wordpress2ghost/">从Wordpress迁移到Ghost</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p> ╮(╯_╰)╭</p>
<p>虽不敢说乔迁新居，但至少算是把家里装修了下。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.j3l11234.com/2016/09/13/wordpress2ghost/" data-id="cizhrahj1000c4rh9yr34jgg8" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>




  
    <article id="post-centos-hyper-video" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/09/12/centos-hyper-video/" class="article-date">
  <time datetime="2016-09-12T05:55:31.000Z" itemprop="datePublished">2016-09-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/09/12/centos-hyper-video/">改变Hyper-v下Centos7的默认分辨率</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>vi /etc/default/grub<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">GRUB_CMDLINE_LINUX=”crashkernel=auto rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet splash video=hyperv_fb:800×600″</div></pre></td></tr></table></figure></p>
<p>save.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.j3l11234.com/2016/09/12/centos-hyper-video/" data-id="cizhrahj2000d4rh9p0ofv6pn" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>




  
    <article id="post-centos-fail2ban" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/09/21/centos-fail2ban/" class="article-date">
  <time datetime="2015-09-20T18:34:16.000Z" itemprop="datePublished">2015-09-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/09/21/centos-fail2ban/">CentOS下fail2ban安装与配置教程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>fail2ban用于监视系统日志，通过正则表达式匹配错误错误信息，设置一定的条件触发相应的屏蔽动作。<br> 在笔者的vps里，主要是用于ssh的保护，ssh登录错误的时候会记录到 <strong>/var/log/secure</strong>，fail2ban通过 gamin检测到新增日志，10min内同一ip连续登陆5次就会封禁30min。<br> 当然，一个足够的强密码也是必须的！</p>
<p>官方主页：<a href="http://www.fail2ban.org/wiki/index.php/Main_Page" target="_blank" rel="external">http://www.fail2ban.org/wiki/index.php/Main_Page</a></p>
<p>github：<a href="https://github.com/fail2ban/fail2ban" target="_blank" rel="external">https://github.com/fail2ban/fail2ban</a></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p> 这里有两种安装方式，使用yum安装或者通过rpm安装。笔者的系统版本是CentOS-6.7</p>
<ul>
<li>yum安装</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">#首先安装epel源，如果已经安装可以跳过此步</div><div class="line">yum install -y epel-release</div><div class="line"></div><div class="line">#然后安装fail2ban：</div><div class="line">yum install -y fail2ban</div></pre></td></tr></table></figure>
<ul>
<li>rpm安装</li>
</ul>
<p>fail2ban依赖下面四个安装包：<br><strong>ed</strong>： Linux 操作系统下最简单的文本编辑器，以行为单位对文件进行编辑<br><strong>gamin-python</strong>： python调用gamin的一个模块，gamin实现了一套监控文件变化的机制<br><strong>ipset</strong>： 管理 ip地址/端口/mac地址 的模块，一般用于辅助提高iptables的性能<br><strong>python-inotify</strong>： python的一个模块，实现了文件变化通知机制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">#其中前三个都可以使用yum安装：</div><div class="line">yum -y install ed gamin-python ipset python-inotify</div><div class="line"></div><div class="line">#然后根据系统架构不同，使用不同的rpm包安装：</div><div class="line">#i386</div><div class="line">rpm -Uvh ftp://rpmfind.net/linux/atrpms/el6-i386/atrpms/stable/python-inotify-0.9.1-1.1.el6.noarch.rpm</div><div class="line">rpm -Uvh ftp://rpmfind.net/linux/epel/testing/6/i386/fail2ban-0.9.3-1.el6.noarch.rpm</div><div class="line"></div><div class="line">#x86-64</div><div class="line">rpm -Uvh ftp://rpmfind.net/linux/atrpms/el6-x86_64/atrpms/stable/python-inotify-0.9.1-1.1.el6.noarch.rpm</div><div class="line">rpm -Uvh ftp://rpmfind.net/linux/epel/testing/6/x86_64/fail2ban-0.9.3-1.el6.noarch.rpm</div></pre></td></tr></table></figure>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>目前的最新版本是0.9.3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">配置文件位于：</div><div class="line">/etc/fail2ban/action.d/ //采取相对应措施的目录</div><div class="line">/etc/fail2ban/fail2ban.conf //fail2ban的配置文件</div><div class="line">/etc/fail2ban/fail2ban.d/ //fail2ban的配置文件目录</div><div class="line">/etc/fail2ban/filter.d/ //具体过滤规则文件目录</div><div class="line">/etc/fail2ban/jail.conf //阻挡设定文件</div><div class="line">/etc/fail2ban/jail.d/ //阻挡设定文件的目录</div><div class="line">/etc/fail2ban/paths-*.conf //不同linux发行版下路径的相关设置，在jail.conf的[INCLUDES]里指定</div></pre></td></tr></table></figure>
<p><strong>fail2ban.conf</strong> 是针对fail2ban程序运行本身的一些设置。<br><strong>jail.conf</strong> 是fail2ban的业务功能设置，里面设置了需要监控那些服务以及如何保护等，里边已经针对常用的服务提供了监控方案，比如sshd、apache、3proxy等，笔者只启用了sshd的保护。</p>
<p>jail.conf里的注释十分丰富，简单介绍一些基本的设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">#所有监控项的默认设置</div><div class="line">[DEFAULT]</div><div class="line">#忽略的ip，这里表示本机ip将永不被封禁</div><div class="line">ignoreip = 127.0.0.1/8</div><div class="line">#封禁时间，单位为秒</div><div class="line">bantime = 600</div><div class="line"></div><div class="line">#监控周期，表示在600s内，失败次数达到maxretry的主机将会被封禁</div><div class="line">findtime = 600</div><div class="line"></div><div class="line">#最大重试次数，表示在findtime内，失败次数达到5次的主机将会被封禁</div><div class="line">maxretry = 5</div><div class="line"></div><div class="line">#默认关闭对所有服务的保护</div><div class="line">enabled = false</div></pre></td></tr></table></figure>
<p>启用sshd的保护很简单，在jail.conf的[sshd]中加上一行<strong>enabled = true</strong>就可以：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># SSH servers</div><div class="line">#</div><div class="line"></div><div class="line">[sshd]</div><div class="line"></div><div class="line">port = ssh</div><div class="line">logpath = %(sshd_log)s</div><div class="line">enabled = true</div></pre></td></tr></table></figure>
<p>最后就是设置服务自启动了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chkconfig fail2ban on</div><div class="line">service fail2ban start</div></pre></td></tr></table></figure>
<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>Q：日志中出现<strong>Error starting action</strong>错误</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">fail2ban.server[2228]: INFO Jail sshd is not a JournalFilter instance</div><div class="line">fail2ban.jail[2228]: INFO Jail &apos;sshd&apos; started</div><div class="line">fail2ban.action[2228]: ERROR iptables -w -N f2b-sshd#012iptables -w -A f2b-sshd -j RETURN#012iptables -w -I INPUT -p tcp -m multiport --dports ssh -j f2b-sshd -- stdout: &apos;&apos;</div><div class="line">fail2ban.action[2228]: ERROR iptables -w -N f2b-sshd#012iptables -w -A f2b-sshd -j RETURN#012iptables -w -I INPUT -p tcp -m multiport --dports ssh -j f2b-sshd -- stderr: &apos;&apos;</div><div class="line">fail2ban.action[2228]: ERROR iptables -w -N f2b-sshd#012iptables -w -A f2b-sshd -j RETURN#012iptables -w -I INPUT -p tcp -m multiport --dports ssh -j f2b-sshd -- returned 2</div><div class="line">fail2ban.actions[2228]: ERROR Failed to start jail &apos;sshd&apos; action &apos;iptables-multiport&apos;: Error starting action</div></pre></td></tr></table></figure>
<p>A：fail2ban-0.9.3在执行iptable命令时，加上了-w参数用于防止冲突，但是iptables-1.4.20才有这个参数，而CentOS6.7下的是iptables-1.4.7,因此导致iptable的命令执行失败，Github有这个问题：<br><a href="https://github.com/fail2ban/fail2ban/issues/1122" target="_blank" rel="external">https://github.com/fail2ban/fail2ban/issues/1122</a></p>
<p>一个折中方案是，修改/etc/fail2ban/action.d/iptables-common.conf文件，去掉<strong><lockingopt></lockingopt></strong>，也就是-w参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># Option: iptables</div><div class="line"># Notes.: Actual command to be executed, including common to all calls options</div><div class="line"># Values: STRING</div><div class="line">#iptables = iptables &lt;lockingopt&gt;</div><div class="line">iptables = iptables</div></pre></td></tr></table></figure>
<p>Q：日志中出现<strong>ERROR findFailure failed to parse timeText</strong>错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Sep 21 09:57:51 12345 fail2ban.filter[1588]: ERROR findFailure failed to parse timeText: Sep 21 09:57:26 1234</div><div class="line"></div><div class="line">#在fail2ban-0.9.2 是这样的错误</div><div class="line">Sep 21 10:05:37 12345 fail2ban.filterpyinotify[1305]: ERROR Error in FilterPyinotify callback: mktime argument out of range</div></pre></td></tr></table></figure>
<p>A：这个错误源于一个不算bug的bug，当用户的hostname前面为数字的时候就会触发</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@12345 ~]# hostname</div><div class="line">12345.domain.com</div></pre></td></tr></table></figure>
<p>在日志中，<strong>12345.domain.com</strong>前面的<strong>12345</strong>被当作是年份被解析了，笔者的vps很不幸，hostname就是数字开头的，而且当时的版本还是fail2ban-0.9.2，排错过程十分辛苦。<br> 解决的方法有很多，比如最直接的修改hostname</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /etc/sysconfig/network</div></pre></td></tr></table></figure>
<p>而笔者采用的方案是修改 rsyslog 的日志格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">vi /etc/rsyslog.conf</div><div class="line"></div><div class="line"># Use default timestamp format</div><div class="line">#$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat</div><div class="line">$template FileFormat,&quot;%TIMESTAMP:::date-rfc3339% %HOSTNAME% %syslogtag%%msg:::sp-if-no-1st-sp%%msg:::drop-last-lf%\n&quot;</div><div class="line">$ActionFileDefaultTemplate FileFormat</div></pre></td></tr></table></figure>
<p>重启 rsyslog 服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service rsyslog restart</div></pre></td></tr></table></figure>
<p>关于rsyslog日志格式的说明：<br><a href="http://www.rsyslog.com/doc/v8-stable/configuration/templates.html#reserved-template-names" target="_blank" rel="external">http://www.rsyslog.com/doc/v8-stable/configuration/templates.html#reserved-template-names</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.j3l11234.com/2015/09/21/centos-fail2ban/" data-id="cizhrahj0000b4rh9c26jr3tf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>




  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">十月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">三月 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">十二月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">十月 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2011/03/">三月 2011</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2009/07/">七月 2009</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/08/">八月 2008</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2008/04/">四月 2008</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/02/22/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2016/12/04/vue-note/">Vue 笔记</a>
          </li>
        
          <li>
            <a href="/2016/11/25/update-webpack-1to2/">Webpack 1 更新到 Webpack 2 的蹚坑记</a>
          </li>
        
          <li>
            <a href="/2016/11/23/yum-remove-with-exclude/">在 yum remove 时保留特定依赖</a>
          </li>
        
          <li>
            <a href="/2016/10/09/hdzx_v4-launched/">学活新版本系统上线了</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 j3l11234<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      </br><script src="https://s22.cnzz.com/z_stat.php?id=1253355046&web_id=1253355046" language="JavaScript"></script>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>